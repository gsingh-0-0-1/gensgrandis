<!-- Copyright (C) Gurmehar Singh 2020 - All Rights Reserved
/* Unauthorized copying or distribution of this file, via any medium is strictly prohibited
/* Proprietary and confidential
/* Written by Gurmehar Singh <gurmehar@gmail.com>
/-->


<!DOCTYPE html>
<html lang="en">
<head>
	<title>GÄ“ns Grandis</title>

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Lato:wght@300&display=swap" rel="stylesheet">

	<style type="text/css">

		gui {
			position: fixed;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
		}
		body {
			background-color: #000;
		}

		.button {
			border: none;
			color: white;
			padding: 15px 24px;
			text-align: center;
			display: inline-block;
			margin: 4px 2px;
			cursor: pointer;
			font-family: Lato;
		}

		.button:focus{
			outline: none;
		}

		.button.addbuilding{
			font-size: 1.5vh;
			padding: 10px 10px;
		}

		.city_name_input:focus{
			outline: none;
		}

		.city_sidebar_small_cont{
			position: absolute;
			width: 80%; 
			height: 15px; 
			color: #daa; 
			font-family: Lato; 
			font-size: 1.6vh
		}

		.tutorialpanel{
			position: fixed; 
			left: 50%; 
			top: 5%; 
			transform: 
			translate(-50%, 0%); 
			width: 20%; 
			height: 15%; 
			background-color: #4a4aaa; 
			z-index: 2; 
			border: 2px solid #999; 
			font-size: 2vh; 
			color: #bbb; 
			text-align: center; 
			font-family: Lato; 
			padding: 10px 10px; 
			display: none;
			overflow: auto;
		}

		.playerbutton{
			padding: 0 0 ;
			text-align: center;
			border: none;
		}

		.playerbutton:focus{
			outline: none;
		}

		input:focus{
			outline: none;
		}

		#city_center_trading > div {position: relative; width: 100%; left: 0%; color: #bbb; font-size: 1.6vh; padding: 2px 2px; font-family: Verdana;}
		#city_center_trading > div:nth-child(odd) {background-color: #222;}
		#city_center_trading > div:nth-child(even) {background-color: #777;}

		#tile_level_table > tbody {background-color: #111;}

		#tile_level_table > tbody > tr > td{
			border: 2vh solid #bc8f8f;
			box-sizing: border-box;
		}

		/*#tile_level_table > tbody > tr:first-child > td:first-child{
			border-left: 2vh solid transparent;
			border-top: 2vh solid transparent;
		}
		#tile_level_table > tbody > tr:first-child > td:last-child{
			border-right: 2vh solid transparent;
			border-top: 2vh solid transparent;
		}
		#tile_level_table > tbody > tr:last-child > td:first-child{
			border-left: 2vh solid transparent;
			border-bottom: 2vh solid transparent;
		}
		#tile_level_table > tbody > tr:last-child > td:last-child{
			border-right: 2vh solid transparent;
			border-bottom: 2vh solid transparent;
		}

		#tile_level_table > tbody > tr:first-child > td{
			border-top: 2vh solid transparent;
		}
		#tile_level_table > tbody > tr > td:first-child{
			border-left: 2vh solid transparent;
		}
		#tile_level_table > tbody > tr > td:last-child{
			border-right: 2vh solid transparent;
		}
		#tile_level_table > tbody >tr:last-child > td{
			border-bottom: 2vh solid transparent;
		}*/
	</style>
</head>
<body>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!--
	Template for a tile on the tile-view for cities
	-->
	<input type="button" id="tiletemplate" style="position: fixed; left: 0px; top: 0px; width: 100px; height: 100px; transform: translate(-50%, -50%); background-color: #3a3; display: initial; z-index: 0; box-sizing: border-box" onclick="javascript:selectTileFromTileView(this)">

	<gui id="gui" style="z-index: 1;">
	</gui>

	<div id="loadingscreen" style="position: fixed; left: 0%; top: 0%; width: 100%; height: 100%; background-color: #000; text-align: center; color: #ddd; font-family: 'Times New Roman'; z-index: 3">
		<div style="position: relative; top: 50%; font-size: 50px">
			Waiting for your turn...
		</div>
	</div>

	<div id="unit_desc" style="position: fixed; left: 0%; top: 75%; width: 30%; height: 25%; background-color: #4a4aaa; border-top: 5px solid #d9d0d0; border-right: 5px solid #d9d0d0; box-sizing: border-box; z-index: 0; display: none">
		<div id="unit_desc_name" style="position: relative; left: 6%; top: 10%; font-family: Verdana; font-size: 20px; color: #ffffff">
		</div>
		<div id="unit_desc_x" style="position: relative; left: 10%; top: 18%; font-family: Verdana; font-size: 20px; color: #ffffff">
		</div>
		<div id="unit_desc_y" style="position: relative; left: 10%; top: 20%; font-family: Verdana; font-size: 20px; color: #ffffff">
		</div>
		<div id="unit_desc_m" style="position: relative; left: 10%; top: 22%; font-family: Verdana; font-size: 20px; color: #ffffff">
		</div>
		<div id="unit_desc_status" style="position: relative; left: 10%; top: 25%; font-family: Verdana; font-size: 20px; color: #ffffff">
		</div>
	</div>


	<div id="unit_commands_info" style="position: fixed; left: 50%; top: 90%; width: 40%; height: 20%; transform: translate(-50%, -50%); background-color: #4a4aaa; border: 5px solid #d9d0d0; box-sizing: border-box; display: none; z-index: 0; font-family: Courier; font-size: 18px; color: #daa;">
		<div id="general_commands" style="position: fixed; left: 3%; top: 10%;">
			G: Moving Mode 
			<br>
			&nbsp;&nbsp;Click on tile to move
			<br>
			ESC: Deselect Unit
		</div>

		<div id="unit_specific_commands" style="position: fixed; left: 53%; top: 10%">
		</div>

		<div id="endturn_info" style="position: fixed; left: 50%; top: 65%; transform: translate(-50%, 0)">
			T to End Turn
		</div>
	</div>


	<div id="city_center_trading" style="position: fixed; left: 60%; top: 0%; width: 20%; height: 20%; box-sizing: border-box; border-left: 5px solid #d9b0b0; border-top: 5px solid #d9b0b0; border-bottom: 5px solid #d9b0b0; background-color: #444; z-index: 0; display: none; overflow: auto">
	</div>


	<div id="city_info_sidebar" style="position: fixed; left: 80%; top: 0%; width: 20%; height: 100%; background-color: #4a4aaa; border: 5px solid #d9b0b0; box-sizing: border-box; z-index: 0; display: none;">

		<div id="city_info_sidebar_name" style="position: relative; left: 5%; top: 2%; color: #ddd; font-family: Verdana; font-size: 15px; border-bottom: 2px solid white; height: 20px; width: 80%">
		</div>

		<div id="city_info_sidebar_center_loc" class="city_sidebar_small_cont" style="top: 7%; left: 7%">
			Center Location:

			<div id="city_info_sidebar_center_loc_x" style="padding-left: 20px">
			</div>

			<div id="city_info_sidebar_center_loc_y" style="padding-left: 20px">
			</div>
		</div>

		<div id="city_info_sidebar_selected_loc" class="city_sidebar_small_cont" style="top: 14%; left: 7%">
			Selected Tile:

			<div id="city_info_sidebar_selected_loc_x" style="padding-left: 20px">
			</div>

			<div id="city_info_sidebar_selected_loc_y" style="padding-left: 20px">
			</div>	

			<div id="city_info_sidebar_selected_pop" style="padding-left: 20px">
			</div>

			<div id="city_info_sidebar_selected_food" style="padding-left: 20px">
			</div>

			<div id="city_info_sidebar_selected_farm_food" style="padding-left: 20px">
			</div>

		</div>

		<div id="city_info_sidebar_expand" class="city_sidebar_small_cont" style="top: 27%; left: 7%">
			Expand City...

			<br>

			<div id="" style="padding-left: 20px">

				&nbsp;&nbsp;
				<table>

					<tr>
						<td></td>
						<td>
							<input class="button" type="button" value="N" style="font-size: 1vh; font-family: Lato; background-color: #8c1a1a; padding: 0.4vh 0.4vh" onclick="javascript:expandCity([0, 1])">
						</td>
						<td></td>
					</tr>

					<tr>
						<td>
							<input class="button" type="button" value="W" style="font-size: 1vh; font-family: Lato;background-color: #8c8c1a; padding: 0.4vh 0.4vh" onclick="javascript:expandCity([-1, 0])">
						</td>
						<td></td>
						<td>
							<input class="button" type="button" value="E" style="font-size: 1vh; font-family: Lato;background-color: #1a1a8c; padding: 0.4vh 0.4vh" onclick="javascript:expandCity([1, 0])">	
						</td>
					</tr>
					<tr>
						<td></td>
						<td>
							<input class="button" type="button" value="S" style="font-size: 1vh; font-family: Lato;background-color: #1a8c1a; padding: 0.4vh 0.4vh" onclick="javascript:expandCity([0, -1])">
						</td>
						<td></td>
					</tr>
				</table>

			</div>

		</div>

		<div class="city_sidebar_small_cont" style="top: 45%; left: 7%">
			<input class="button" type="button" value="Tile Level Interface >>" style="font-size: 16px; font-family: Lato; background-color: #777; padding: 5px 5px" onclick="javascript:showTileLevelInterface()">
		</div>

		<div id="city_info_sidebar_breakoff_people" class="city_sidebar_small_cont" style="top: 50%; left: 7%">
			Break city off into people...

			<div style="padding-left: 20px">

				<input class="button" type="button" value="Break >>" style="font-size: 16px; font-family: Lato; background-color: #111; padding: 5px 5px" onclick="javascript:breakCity()">

			</div>

		</div>

		<div id="city_info_sidebar_view_city_tiles" class="city_sidebar_small_cont" style="top: 60%; left: 7%">
			View city...

			<div style="padding-left: 20px">

				<input class="button" type="button" value="View >>" style="font-size: 16px; font-family: Lato; background-color: #040; padding: 5px 5px" onclick="javascript:showCityTileView()">

			</div>

		</div>

		<div id="city_info_sidebar_redirect_food" class="city_sidebar_small_cont" style="top: 67%; left: 7%">
			Redirect food...

			<div style="padding-left: 20px">

				<input class="button" type="button" value="Redirect >>" style="font-size: 16px; font-family: Lato; background-color: #400; padding: 5px 5px" onclick="javascript:redirectFood();">
				<br>
				<input class="button" type="text" style="font-size: 16px; font-family: Lato; background-color: #aae; padding: 5px 5px; color: #111" id="foodRedirectTextInput" placeholder="--Redirect amount--">

			</div>			

		</div>

		<div id="city_info_sidebar_produce_reg" class="city_sidebar_small_cont" style="top: 80%; left: 7%">
			Produce unit:<br>Regular<br>

			<select id="select_unit_to_produce_reg">
				<option value="">-Select a unit-</option>
				<option value="RB">Riverboat</option>
			</select>

			<br>

			<button onclick="javascript:changeCityProduction('reg')">Produce</button>

			<br>

			[ <span id="city_info_sidebar_progress_reg"></span> / <span id="city_info_sidebar_prod_target_reg"></span> ] 

			<br>

			<span id="city_info_sidebar_prod_unit_reg"></span>

		</div>


		<div id="city_info_sidebar_produce_mil" class="city_sidebar_small_cont" style="top: 80%; left: 57%">
			Produce unit:<br>Military<br>

			<select id="select_unit_to_produce_mil">
				<option value="">-Select a unit-</option>
				<option value="L">Legion</option>
			</select>

			<br>

			<button onclick="javascript:changeCityProduction('mil')">Produce</button>

			<br>

			[ <span id="city_info_sidebar_progress_mil"></span> / <span id="city_info_sidebar_prod_target_mil"></span> ]

			<br>

			<span id="city_info_sidebar_prod_unit_mil"></span>

		</div>

	</div>







	<div id="city_name_input_container" style="position: fixed; left: 75%; top: 5%; width: 20%; height: 15%; background-color: #4a4aaa; z-index: 0; color: #ddd; font-family: Verdana; font-size: 17px; display: none; border: 2px solid #aaaac5">
		<div style="position: relative; top: 10%; left: 5%;">
			Enter a name for this city:
		</div>
		<input type="text" id="city_name_input_box" class="city_name_input" style="position: relative; background-color: rgba(255, 255, 255, 0); border: none; border-bottom: 2px solid white; top: 40%; left: 10%; color: #ddd" onkeypress="javascript:handleCityNameInput(event)" maxlength="20">

		<input type="hidden" id="city_naming_id">
	</div>

	<div id="city_tile_view_screen" style="position: fixed; left: 50%; top: 50%; width: 50%; height: 50%; transform: translate(-50%, -50%); z-index: 0; display: initial; background-color: #333; border: 10px solid #bbb; overflow: scroll">
	</div>





	<div id="tile_level_interface" style="position: fixed; left: 0%; top: 0%; width: 100%; height: 100%; z-index: 0; display: initial; background-color: #222">

		<input class="button" type="button" style="position: absolute; top: 0%; left: 0%; background-color: #bb6666; padding: 7px 10px" value="X" onclick="javascript:hideTileLevelInterface()">

		<!--<span style="position: absolute; left: 12.5%; top: 25%; width: auto; font-size: 2vh; font-family: Lato; color: #ffefef; transform: translate(-50%, 0);">Add Buildings</span>

		<input class="button" type="button" id="subtile_building_select_FA" style="position: absolute; left: 12.5%; top: 30%; width: 50px; height: 50px; padding: 7px 10px; transform: translate(-50%, 0); background-size: 100%; background-image: url('/resources/building_icons/FA.png')" onclick="javascript:renderBuildingInSubtileView(FARM_TEXTURE)">

		<input class="button" type="button" id="subtile_building_select_BA" style="position: absolute; left: 12.5%; top: 40%; width: 50px; height: 50px; padding: 7px 10px; transform: translate(-50%, 0); background-size: 100%; background-image: url('/resources/building_icons/BA.png')" onclick="javascript:renderBuildingInSubtileView(BARRACKS_TEXTURE)">

		<input class="button" type="button" id="subtile_building_select_AM" style="position: absolute; left: 12.5%; top: 50%; width: 50px; height: 50px; padding: 7px 10px; transform: translate(-50%, 0); background-size: 100%; background-image: url('/resources/building_icons/AM.png')" onclick="javascript:renderBuildingInSubtileView(ARMORY_TEXTURE)">

		<input class="button" type="button" id="subtile_building_select_FO" style="position: absolute; left: 12.5%; top: 60%; width: 50px; height: 50px; padding: 7px 10px; transform: translate(-50%, 0); background-size: 100%; background-image: url('/resources/building_icons/FO.png')" onclick="javascript:renderBuildingInSubtileView(FORGE_TEXTURE)">

		<input class="button" type="button" id="subtile_building_select_FO" style="position: absolute; left: 12.5%; top: 70%; width: 50px; height: 50px; padding: 7px 10px; transform: translate(-50%, 0); background-size: 100%; background-image: url('/resources/building_icons/X.png')" onclick="javascript:removeBuildingInSubtileView()">-->

		<input class="button" type="button" style="position: absolute; top: 95%; left: 93%; background-color: #bb6666; padding: 7px 10px; font-size: 1.1vh" value="Apply Changes" onclick="javascript:applyTileGridChanges()">


		<div id="tile_level_info" style="position: absolute; top: 50%; left: 70%; width: 25%; height: auto; transform: translate(0%, -50%); font-family: Lato; color: #ffefef; font-size: 1.7vh; overflow: auto">

			This is the tile-level management screen. Here, you can add buildings to your tile. Based on how much population your tile has, you will be able to add buildings to more of these "sub-tiles" - below is an explanation of the buildings you can add.<br><br>

			Each building gives a 4% boost to a certain sector of your city - see below for specifics.<br><br>


			<div style="font-size: 2vh">
				<input class="button" type="button" style="width: 5vh; height: 5vh; background-size: 100%; background-image: url('/resources/building_icons/FA.png'); vertical-align: top">
				<input class="button addbuilding" type="button" style="width: auto; height: 5vh; background-color: #b66; text-align: left; vertical-align: top;" value="+ Add Building" onclick="javascript:renderBuildingInSubtileView(FARM_TEXTURE)">
				<br>
				Farm
			</div>

			&nbsp;&nbsp;&nbsp;&nbsp;Farms apply their boost to tile food, allowing your population to grow more.<br><br>

			<span style="font-size: 2vh">
				<input class="button" type="button" style="width: 5vh; height: 5vh; padding: 7px 10px; background-size: 100%; background-image: url('/resources/building_icons/BA.png')">
				<input class="button addbuilding" type="button" style="width: auto; height: 5vh; background-color: #b66; text-align: left; vertical-align: top;" value="+ Add Building" onclick="javascript:renderBuildingInSubtileView(BARRACKS_TEXTURE)">
				<br>
				Barracks
			</span><br>

			&nbsp;&nbsp;&nbsp;&nbsp;A barracks applies its boost to hiring some of your population to produce military units.<br><br>

			<span style="font-size: 2vh">
				<input class="button" type="button" style="width: 5vh; height: 5vh; padding: 7px 10px; background-size: 100%; background-image: url('/resources/building_icons/AM.png')">
				<input class="button addbuilding" type="button" style="width: auto; height: 5vh; background-color: #b66; text-align: left; vertical-align: top;" value="+ Add Building" onclick="javascript:renderBuildingInSubtileView(ARMORY_TEXTURE)">
				<br>
				Armory
			</span><br>

			&nbsp;&nbsp;&nbsp;&nbsp;An armory splits its boost between hiring people to produce military units and to produce regular units.<br><br>

			<span style="font-size: 2vh">
				<input class="button" type="button" style="width: 5vh; height: 5vh; padding: 7px 10px; background-size: 100%; background-image: url('/resources/building_icons/FO.png')">
				<input class="button addbuilding" type="button" style="width: auto; height: 5vh; background-color: #b66; text-align: left; vertical-align: top;" value="+ Add Building" onclick="javascript:renderBuildingInSubtileView(FORGE_TEXTURE)">
				<br>
				Forge
			</span><br>

			&nbsp;&nbsp;&nbsp;&nbsp;Forges work a bit like armories, but they use more of their boost to produce regular units than military units.<br><br>

			<br><br><br>

			<input class="button" type="button" id="subtile_building_select_FO" style="width: 50px; height: 50px; background-size: 100%; background-image: url('/resources/building_icons/X.png'); margin: 0px 0px; padding: 0px 0px" onclick="javascript:removeBuildingInSubtileView()">
			<input class="button addbuilding" type="button" style="width: auto; height: 50px; background-color: #000; text-align: left; vertical-align: top; margin: 0px 0px" value="Remove Building" onclick="javascript:removeBuildingInSubtileView()">


		</div>

		<div id="tile_level_canvas" style="position: fixed; left: 35%; top: 50%; height: 100vh; width: 100vh; transform: translate(-50%, -50%)">
		</div>

	</div>




	<div id="music_holder" style="position: fixed; left: 3%; top: 5%; width: 25%; height: 20%; background-color: #555; border: 2px solid #999; z-index: 3; color: #999; font-family: Lato; overflow-y: scroll">
		<div style="position: sticky; left: 0%; top: 0%; padding: 5px 5px; background-color: #333; font-size: 1.9vh">
			Game Soundtrack
		</div>

	</div>

	<div id="game_options" style="position: fixed; left: 3%; top: 30%; width: 25%; height: 20%; background-color: #555; border: 2px solid #999; z-index: 3; color: #999; font-family: Verdana">
		<div style="position: relative; padding: 5px 5px; background-color: #333; font-size: 1.9vh">
			Game Options
		</div>

		<button id="play_or_pause" class="button" style="position: relative; background-color: #b48888; color: #555; font-family: Verdana; top: 5%; left: 5%; transform: translate(0%, 0%); padding: 7px 7px" onclick="javascript:pauseOrPlayGame()">
			Pause Game
		</button>
	</div>




	<div id="tutorial_ask" class="tutorialpanel">
		Welcome to singleplayer! Would you like to start the tutorial?
		<input class="button" type="button" style="position: fixed; background-color: #88b488; color: #555; font-family: Courier; top: 65%; left: 40%; transform: translate(-50%, 0%); padding: 7px 7px" value="Yes" onclick="javascript:startTutorial()">

		<input class="button" type="button" style="position: fixed; background-color: #b48888; color: #555; font-family: Courier; top: 65%; left: 60%; transform: translate(-50%, 0%); padding: 7px 7px" value="No" onclick="javascript:hideTutorialAsk()">
	</div>


	<div id="tutorial_1" class="tutorialpanel">
		You've just spawned into the game - and you have one "People" unit. Try clicking on it - it should light up and you'll see some info in the bottom left corner of the screen.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>


	<div id="tutorial_2" class="tutorialpanel">
		To move your camera around, use the arrow keys. To move up and down, use SPACE and "Z". Also, you're currently looking north - to look south, use "S", and to look back north, use "W".<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>


	<div id="tutorial_3" class="tutorialpanel">
		Great! Now, press the "G" key. You should see that the unit is now in "moving" mode. Click on any of the 8 tiles around the unit to move the unit to that tile.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_4" class="tutorialpanel">
		When you moved the unit, you might have noticed that the "Movement" of the unit decreased by 1. You have a limited amount of movement each "turn" for each unit.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_5" class="tutorialpanel">
		Keep exploring around until your unit's movement runs out. When that happens, press "T" to end your turn. Also, take a look at the bottom-center panel for some more info.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_6" class="tutorialpanel">
		Now that you've got the basics of unit movement down, select your unit again if you don't already have it selected. Press "B" to build a city, and name it whatever you'd like.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">
	</div>

	<div id="tutorial_7" class="tutorialpanel">
		Go ahead and click your city tile. You should see a sidebar pop up on the right - let's go through it together.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_8" class="tutorialpanel">
		The first few lines should be self-explanatory - they show the location of the center of the selected city, the location of the selected tile, and the tile's population and food.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_9" class="tutorialpanel">
		The population of any tile will grow up to just about the amount of food it has - no more. Grass tiles have a good amount of food, forest tiles have less. Tiles next to water have more food, and tiles on higher elevations have less food.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_10" class="tutorialpanel">
		Below those details, you'll see a menu called "Expand City". If, on any tile, you have 100 or more people, 50 of those people can move to an adjacent tile, leaving 50 or more behind. Try it!<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">
	</div>

	<div id="tutorial_11" class="tutorialpanel">
		Next, you'll see a button called "Break >>". If you have 150 or more people on a tile, this button takes 100 of those people to create another "People" unit. You can use this unit to explore or create more cities.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_12" class="tutorialpanel">
		And lastly, you'll see the "View >>" and "Redirect >>" buttons. Go ahead and click on the "View >>" button - it'll show you a 2-D view of the tiles in your currently selected city. Hit ESC to close the view.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">
	</div>


	<div id="tutorial_13" class="tutorialpanel">
		Now, say your city has some tiles with a lot of food, but you want to expand elsewhere. You can redirect food from one tile to another. First, select the tile that you want to take food from.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_14" class="tutorialpanel">
		Type the amount of food you want to redirect into the text box below the "Redirect >>" button. Click the "Redirect >>" button - it'll open up the 2-D view. Here, select the tile that you want to redirect the food to.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_15" class="tutorialpanel">
		Hit ESC to close the 2-D view. You should see the sidebar update for the tile you initially selected, and if you click on the tile that you redirected food to, you should see that it has more food now.<br>

		<input class="button" type="button" style="position: relative; background-color: #88b488; color: #555; font-family: Courier; padding: 7px 7px" value="Continue" onclick="javascript:nextTutorial(this)">

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">

	</div>

	<div id="tutorial_16" class="tutorialpanel">
		That's it for now! If that was a lot of info, don't worry - you'll get the hang of it soon enough. If you have any questions, you can find the link to our discord on the home page. Thanks for playing!<br>

		<input class="button" type="button" style="position: relative; background-color: #b48888; color: #555; font-family: Courier; padding: 7px 7px" value="Exit" onclick="javascript:endTutorial(this)">
	</div>

</body>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r124/three.js"></script>
<script type="text/javascript" src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>

<script src="http://mrdoob.github.com/three.js/examples/js/postprocessing/EffectComposer.js"></script>
<script src="http://mrdoob.github.com/three.js/examples/js/postprocessing/RenderPass.js"></script>
<script src="http://mrdoob.github.com/three.js/examples/js/postprocessing/MaskPass.js"></script>
<script src="http://mrdoob.github.com/three.js/examples/js/postprocessing/ShaderPass.js"></script>
<script src="http://mrdoob.github.com/three.js/examples/js/shaders/CopyShader.js"></script>
<script src="https://threejs.org/examples/js/postprocessing/OutlinePass.js"></script>

<script src="https://threejs.org/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://threejs.org/examples/js/utils/SkeletonUtils.js"></script>

<script src="/js/colors.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/tutorial.js"></script>
<script src="/js/audioutils.js"></script>
<script src="/js/unitdraws.js"></script>
<script src="/js/unitutils.js"></script>
<script src="/js/initialization.js"></script>
<script src="/js/mousehandler.js"></script>
<script src="/js/tilelevelutils.js"></script>
<script src="/js/borderutils.js"></script>

<script src="/js/socket.io.js"></script>

<script>

	var cont = document.getElementById("music_holder")

	addSong("gg_1", "Beginnings", cont)
	addSong("gg_2", "Sailing", cont)
	//addSong("gg_3", "March of the Legion", cont)
	addSong("gg_4", "Exploring", cont)
	addSong("gg_5", "Gens Grandis", cont)
	addSong("gg_6", "Sly", cont)

	var socket = io(window.location.pathname);

	var multi = false

	if (window.location.pathname.includes("gameroom")){
		multi = true
	}

	if (!multi){
		showTutorialAsk()
	}

	//****************************************************************************************//
	//******************************CONSTANTS AND INITIALIZATION******************************//
	//****************************************************************************************//
	const leftarrowcode = 37
	const uparrowcode = 38
	const rightarrowcode = 39
	const downarrowcode = 40
	const spacekeycode = 32
	const shiftkeycode = 16
	const akeycode = 65
	const dkeycode = 68
	const esckeycode = 27
	const endturnkeycode = 84
	const enterkeycode = 13

	var unit_types = ["reg", "mil"]

	var unit_corresponds = {"P" : "People", 
							"RB" : "Riverboat",
							"L" : "Legion"}

	var unit_movements = {"P" : 5, 
							"RB" : 10, 
							"L" : 3}

	var unit_commands = {"P" : "B: Build city",
						"RB" : "",
						"L" : ""}

	var unit_produce_times = {"RB" : 500,
								"L" : 250}

	var unit_z_offsets = {"P" : 0.7,
						"RB" : 0,
						"L" : 0.7}

	//unit templates
	var people_template = "P~x:xhere,y:yhere,n:100,m:" + unit_movements["P"]
	var riverboat_template = "RB~x:xhere,y:yhere,m:" + unit_movements["RB"]
	var legion_template = "L~x:xhere,y:yhere,m:" + unit_movements["L"]

	var moving_unit = false;
	var expanding_city = false;

	var unit_z_offset = 0.7

	var mincitytilepop = 50

	var city_tile_hut_locs = [[0, 0], 
								[0.2, 0.1], 
								[0, 0.1], 
								[-0.1, 0.15], 
								[-0.1, -0.1], 
								[0.1, 0],
								[-0.2, 0.1],
								[0.1, -0.1],
								[0.2, -0.22],
								[0.3, -0.2]]
	var MAX_CITY_TILE_SIZE = 6
	var TILE_POP_STEP = 100

	var urlParams = new URLSearchParams(window.location.search);
	const GAMEID = urlParams.get("gameid")
	/*var ACCESSCODE = urlParams.get("accesscode")
	var ACSTRING = "accesscode=" + ACCESSCODE*/

	const LAND_TILE_CODE = 'l'

	const FOREST_START_TILE_CODE = 's,l,f'
	const FOREST_TILE_CODE = 'l,f'

	const MOUNTAIN_START_TILE_CODE = 's,l,m'
	const MOUNTAIN_TILE_CODE = 'l,m'

	const WATER_BODY_START_TILE_CODE = 's,w,l,n'
	const WATER_BODY_TILE_CODE = 'w,l,n'

	const RIVER_START_TILE_CODE = 's,w,l,r'
	const RIVER_TILE_CODE = 'w,r'

	const HEIGHT_DELIMITER = "#"
	const INFO_DELIMITER = "|"

	const WORLD_RAD = 500

	var WORLD_SEED = 0

	var activetiles = []
	var exploredtiles = 'null'
	var units = []

	var LOAD_TERRAIN_DIST = 2

	var MOUNTAIN_FOREST_HEIGHT = 1
	var MOUNTAIN_STONE_HEIGHT = 5
	var MOUNTAIN_SNOWCAP_HEIGHT = 6
	var MOUNTAIN_SNOW_HEIGHT = 8.5

	var FILE = "map1"

	var rad = 0.05
	var height = 0.2

	var trunkheight = height * 0.2
	var trunkrad = rad * 0.5

	var leavesheight = height// * 0.8
	var leavesrad = rad

	const leaves_material = new THREE.MeshBasicMaterial( {color: 0x116611} );
	const leaves_geometry = new THREE.BufferGeometry().fromGeometry(new THREE.ConeGeometry( leavesrad, leavesheight, 3 ));
	const LEAVES_MESH = new THREE.Mesh( leaves_geometry, leaves_material );

	var cameralooking = 'front'

	var gamecenterx = 550
	var gamecentery = 555

	var camerainitx = gamecenterx
	var camerainity = gamecentery
	var camerainitz = 5

	const ground_z = -2
	const base_tile_height = 0

	var grid_dict = {}

	//****************************************************************************************//
	//****************************************************************************************//
	//****************************************************************************************//

	//other game functions
	function center(){
		cameravelocity.x = 0
		cameravelocity.y = 0
		camera.position.set(camerainitx, camerainity, camerainitz)
		camera.lookAt(camerainitx, camerainity + 5, camerainitz - 5)
		cameralooking = 'front'
	}

	//basic initialization
	var width = window.innerWidth;
	var height = window.innerHeight;
	var camera = new THREE.PerspectiveCamera( 45, width / height, 1, 50 );
	//camera.rotation.order = 'ZYX'
	var renderer = new THREE.WebGLRenderer({antialias: true});
	//renderer.physicallyCorrectLights = true
	renderer.setSize(width, height);
	document.getElementById('gui').appendChild(renderer.domElement);
	var scene = new THREE.Scene({canvas:gui});
	scene.background = new THREE.Color( 0x000000 );
	scene.add(camera);
	var cameravelocity = new Object()
	cameravelocity.x = 0
	cameravelocity.y = 0
	cameravelocity.z = 0

	var geometry = new THREE.TorusGeometry( 0.5 * Math.sqrt(2, 1/2), 0.02, 8, 4 );
	var material = new THREE.MeshBasicMaterial( { color: 0xaa0000 } );
	var tileoutline = new THREE.Mesh( geometry, material );
	tileoutline.rotation.set(0, 0, Math.PI / 4)
	tileoutline.visible = false
	scene.add( tileoutline );

	var light_z_offset = 4
	var directionalLight_fromSouth = new THREE.DirectionalLight( 0xffffff, 1.5 );
	directionalLight_fromSouth.position.set(camerainitx, camerainity, ground_z + light_z_offset)
	directionalLight_fromSouth.target.position.set(camerainitx, camerainity + 5, ground_z)
	scene.add(directionalLight_fromSouth);
	scene.add(directionalLight_fromSouth.target)


	/*var directionalLight_fromNorth = new THREE.DirectionalLight( 0xffffff, 0.75 );
	directionalLight_fromNorth.position.set(camerainitx, camerainity, ground_z + 3)
	directionalLight_fromNorth.target.position.set(camerainitx, camerainity - 5, ground_z)
	scene.add(directionalLight_fromNorth);
	scene.add(directionalLight_fromNorth.target)*/

	/*var composer = new THREE.EffectComposer(renderer)
	var outlinePass = new THREE.OutlinePass(new THREE.Vector2(window.innerWidth, window.innerHeight), scene, camera);
	var renderPass = new THREE.RenderPass(scene, camera);

	outlinePass.renderToScreen = true;

	outlinePass.edgeStrength = 2;
	outlinePass.edgeGlow = 1;
	outlinePass.visibleEdgeColor.set(0xffffff);
	outlinePass.hiddenEdgeColor.set(0xffffff);

	composer.addPass(renderPass);
	composer.addPass(outlinePass);*/

	//scene.fog = new THREE.Fog(0x888888, 0, 100)


	function getTileBuildingBoosts(id, x, y, center = false){
		if (getTileAt(x, y).tile_grid == undefined){
			return [0, 0, 0]
		}
		if (center){
			var population = cities[id].center.population
		}
		else{
			var population = cities[id].tiles[x + "_" + y].population
		}
		num_armories = 0
		num_forges = 0
		num_barracks = 0
		for (var subtile of SUBTILE_LIST){
			let building = getTileAt(x, y).tile_grid[subtile].building
			if (building == "AM"){
				num_armories += 1
			}
			if (building == "FO"){
				num_forges += 1
			}
			if (building == "BA"){
				num_barracks += 1
			}
		}

		var armories_boost = num_armories * 0.04 * population
		var forges_boost = num_forges * 0.04 * population
		var barracks_boost = num_barracks * 0.04 * population

		return [Math.round(armories_boost, 1), Math.round(barracks_boost, 1), Math.round(forges_boost, 1)]
	}


	//TURN BASED EVENTS AND CHANGES
	function endTurn(){
		//update unit movements
		for (var unit of unitlist){
			unit.m = unit_movements[unit.type]
		}
		if (selectedunitid != 'null'){
			updateUnitBar(selectedunitid)
		}

		//update city populations
		var numcities = cities.length
		for (var cityidx = 0; cityidx < numcities; cityidx++){

			//cities[cityidx].people_turns += getTotalPop(cityidx)


			/*//DEAL WITH UNIT PRODUCTION
			if (cities[cityidx].people_turns >= unit_produce_times[cities[cityidx].producing]){
				var curprod = cities[cityidx].producing
				var targetx = cities[cityidx].center.x
				var targety = cities[cityidx].center.y

				if (curprod == "RB"){
					addRiverboat(targetx, targety)
				}
				if (curprod == "L"){
					addLegion(targetx, targety)
				}

				cities[cityidx].producing = null
				cities[cityidx].people_turns = 0				
			}*/

			//calculate building numbers
			var buildingBoosts = [0, 0, 0]

			var centerBuildingBoosts = getTileBuildingBoosts(cityidx, cities[cityidx].center.x, cities[cityidx].center.y, true)

			buildingBoosts[0] += centerBuildingBoosts[0]
			buildingBoosts[1] += centerBuildingBoosts[1]
			buildingBoosts[2] += centerBuildingBoosts[2]

			for (var tile of Object.keys(cities[cityidx].tiles)){
				var tileBuildingBoosts = getTileBuildingBoosts(cityidx, cities[cityidx].tiles[tile].x, cities[cityidx].tiles[tile].y, false)

				buildingBoosts[0] += tileBuildingBoosts[0]
				buildingBoosts[1] += tileBuildingBoosts[1]
				buildingBoosts[2] += tileBuildingBoosts[2]				
			}

			var armories_boost = buildingBoosts[0]
			var barracks_boost = buildingBoosts[1]
			var forges_boost = buildingBoosts[2]

			var mil_boost = barracks_boost + (armories_boost / 2) + (forges_boost / 4)
			var reg_boost = (forges_boost * 3 / 4) + (armories_boost / 2)

			if (cities[cityidx].producing["mil"] != null){
				cities[cityidx].production_progress["mil"] += mil_boost
			}
			if (cities[cityidx].producing["reg"] != null){
				cities[cityidx].production_progress["reg"] += reg_boost
			}

			for (var type of unit_types){
				if (cities[cityidx].producing[type] != null || cities[cityidx].producing[type] != undefined){
					if (cities[cityidx].production_progress[type] > unit_produce_times[cities[cityidx].producing[type]]){
						var prod = cities[cityidx].producing[type]
						var targetx = cities[cityidx].center.x
						var targety = cities[cityidx].center.y
						if (prod == "L"){
							addLegion(targetx, targety)
						}
						if (prod == "RB"){
							addRiverboat(targetx, targety)
						}
						cities[cityidx].production_progress[type] -= unit_produce_times[cities[cityidx].producing[type]]

						cities[cityidx].producing[type] = null
					}
				}
			}

			growTile(cities[cityidx].center.x, cities[cityidx].center.y, cityidx, true)

			for (var tile of Object.keys(cities[cityidx].tiles)){
				growTile(cities[cityidx].tiles[tile].x, cities[cityidx].tiles[tile].y, cityidx)
			}
		}

		if (viewing_city_sidebar){
			showCitySidebar(selectedcityid, selectedcitytilex, selectedcitytiley)
		}

		socket.emit('turndone')

		if (multi){
			waitForTurn()
		}
	}

	function checkAndLoad(x, y, explore = true){
		//check the appropriate tiles for being loaded or not
		var tiles_to_check = [
		[x, y],
		[x + LOAD_TERRAIN_DIST, y],
		[x - LOAD_TERRAIN_DIST, y],
		[x, y + LOAD_TERRAIN_DIST],
		[x, y - LOAD_TERRAIN_DIST],
		[x + LOAD_TERRAIN_DIST, y + LOAD_TERRAIN_DIST],
		[x + LOAD_TERRAIN_DIST, y - LOAD_TERRAIN_DIST],
		[x - LOAD_TERRAIN_DIST, y - LOAD_TERRAIN_DIST],
		[x - LOAD_TERRAIN_DIST, y + LOAD_TERRAIN_DIST]
		]
		for (var tile of tiles_to_check){
			var tx = tile[0]
			var ty = tile[1]
			if (getTileAt(tx, ty) == undefined && checkValidTile([tx, ty])){
				//render the correct areas
				fetchAndRender([tx - LOAD_TERRAIN_DIST, ty - LOAD_TERRAIN_DIST], [tx + LOAD_TERRAIN_DIST, ty + LOAD_TERRAIN_DIST])
			}
		}
		// "explore" at the correct areas
		if (explore){
			exploreAtCoords(x, y)
		}
	}


	//STUFF TO CONTROL UNITS 

	var selectedunitid = 'null'
	var selectedcolorfactor = 1.2
	//onMouseClick()

	function exploreAtCoords(x, y){
		x = x * 1
		y = y * 1
		for (var expl_x = -1; expl_x <= 1; expl_x++){
			for (var expl_y = -1; expl_y <= 1; expl_y++){
				newx = x + expl_x
				newy = y + expl_y
				if (checkValidTile([newx, newy]) && !exploredtiles.includes(newx + "," + newy)){

					exploredtiles.push(newx + "," + newy)
					getTileAt(newx, newy).visible = true
				}
			}
		}
	}

	function showLoadingScreen(){
		document.getElementById("loadingscreen").style.display = "initial"
	}

	function hideLoadingScreen(){
		document.getElementById("loadingscreen").style.display = "none"
	}

	function waitForTurn(){
		document.getElementById("loadingscreen").style.display = "initial"
	}

	function activateTilesAtCenter(x, y){
		x = x * 1
		y = y * 1
		for (var xoff = -1; xoff <= 1; xoff++){
			for (var yoff = -1; yoff <= 1; yoff++){
				var tile = (x + xoff) + "," + (y + yoff)
				if (!activetiles.includes(tile)){
					activetiles.push(tile)
				}
			}
		}
	}

	function deActivateTilesAtCenter(x, y){
		x = x * 1
		y = y * 1
		for (var xoff = -1; xoff <= 1; xoff++){
			for (var yoff = -1; yoff <= 1; yoff++){
				if (isTileAdjacentToSelfCity(x + xoff, y + yoff)){
					continue
				}
				activetiles.splice(activetiles.indexOf((x + xoff) + "," + (y + yoff)), 1)
			}
		}
	}


	//CITY STUFF

	var viewing_city_sidebar = false
	var selectedcityid = 'null'
	var selectedcitytilex = 'null'
	var selectedcitytiley = 'null'
	//var tileoutline = 'null'

	var in_city_tile_view = false
	var redirecting_food = false

	function reAssignFood(coords1, coords2, amount){
		console.log(coords1, coords2, amount)
		getTileAt(coords1[0], coords1[1]).basefood -= amount
		getTileAt(coords2[0], coords2[1]).basefood += amount
		if (viewing_city_sidebar){
			if ((selectedcitytilex == coords1[0] && selectedcitytiley == coords1[1]) || (selectedcitytilex == coords2[0] && selectedcitytiley == coords2[1])){
				showCitySidebar(selectedcityid, selectedcitytilex, selectedcitytiley)
			}
		}
	}

	function redirectFood(tileobj = '', citycenter = false, x = '', y = ''){
		if (!in_city_tile_view && !citycenter){
			showCityTileView()
		}
		if (!redirecting_food && !citycenter){
			redirecting_food = true
			return
		}
		else{
			if (tileobj == '' && !citycenter){
				return
			}
			else{
				if (!citycenter){
					var split = tileobj.id.split("_")
					var targetx = split[2] * 1
					var targety = split[3] * 1
				}
				else{
					var targetx = x * 1
					var targety = y * 1
				}
				assignTileFood(selectedcitytilex, selectedcitytiley)
				assignTileFood(targetx, targety)

					
				if (!citycenter){
					var redirectval = document.getElementById("foodRedirectTextInput").value
					document.getElementById("foodRedirectTextInput").value = ''
				}
				else{
					var redirectval = document.getElementById("citycentertrading_input").value
					document.getElementById("citycentertrading_input").value = ''
				}

				if (isNaN(redirectval)){
					return
				}

				redirectval = redirectval * 1

				if (redirectval < 1){
					return
				}

				if (getTileAt(selectedcitytilex, selectedcitytiley).basefood - redirectval < mincitytilepop){
					alert("Too much food to redirect! You need to leave 50 food on each tile.")
					return
				}

				//getTileAt(selectedcitytilex, selectedcitytiley).basefood -= redirectval
				//getTileAt(targetx, targety).basefood += redirectval
				reAssignFood([selectedcitytilex, selectedcitytiley], [targetx, targety], redirectval)
				redirecting_food = false

				//showCitySidebar(selectedcityid, selectedcitytilex, selectedcitytiley)

				socket.emit('redirectfood', selectedcitytilex, selectedcitytiley, targetx, targety, redirectval)
			}
		}
	}

	function showCityTileView(argCityID = selectedcityid){
		in_city_tile_view = true
		var tilescreen = document.getElementById("city_tile_view_screen")
		tilescreen.textContent = ''
		tilescreen.style.zIndex = "2"
		tilescreen.style.display = "initial"

		var this_city = cities[argCityID]
		var this_city_x = this_city.center.x
		var this_city_y = this_city.center.y

		var windowheight = tilescreen.clientHeight
		var windowwidth = tilescreen.clientWidth

		//render the city center
		var tiles = Object.keys(this_city.tiles)
		var centertile = this_city_x + "_" + this_city_y
		tiles.push(centertile)

		for (var citytile of tiles){
			var tile = document.getElementById("tiletemplate")
			var tile_clone = tile.cloneNode(true)
			if (citytile == centertile){
				var x = 0
				var y = 0
			}
			else{
				var x = this_city.tiles[citytile].x - this_city_x
				var y = this_city.tiles[citytile].y - this_city_y
			}

			tile_clone.id = this_city.cityID + "_" + this_city.name + "_" + (x + this_city_x) + "_" + (y + this_city_y)

			y = -y
			tile_clone.style.position = "fixed"
			tile_clone.style.zIndex = 2
			tile_clone.style.top = (y*100 + Math.round(windowheight / 2)) + "px"
			tile_clone.style.left = (x*100 + Math.round(windowwidth / 2)) + "px"
			tile_clone.style.border = "1px solid white"

			//get the color of the tile
			if (x == 0 && y == 0){
				tile_clone.style.backgroundColor = "rgb(140, 20, 20)"
			}
			else{
				var col = getTileAt(this_city.tiles[citytile].x, this_city.tiles[citytile].y).material.color
				var r = Math.round(col.r * 255)
				var g = Math.round(col.g * 255)
				var b = Math.round(col.b * 255)

				tile_clone.style.backgroundColor = "rgb(" + r + ", " + g + ", " + b + ")"
			}

			document.getElementById("city_tile_view_screen").appendChild(tile_clone)
		}
	}

	function selectTileFromTileView(obj){
		if (redirecting_food){
			redirectFood(obj)
			return
		}
		//alert("here")
		var split = obj.id.split("_")
		var x = split[2] * 1
		var y = split[3] * 1
		var id = split[0] * 1
		showCitySidebar(id, x, y)
	}

	function hideCityTileView(){
		in_city_tile_view = false
		document.getElementById("city_tile_view_screen").style.zIndex = "0"
		document.getElementById("city_tile_view_screen").style.display = "none"
	}


	function breakCity(){
		var targetpop = 100
		//check if there is enough population to break off into people

		if (tileHasUnit(selectedcitytilex, selectedcitytiley)){
			return
		}

		//first check if we are at the city center
		if (isCityCenter(selectedcityid, selectedcitytilex, selectedcitytiley)){
			var population = cities[selectedcityid].center.population
			if (population - targetpop < mincitytilepop){
				alert("Not enough population!")
				return
			}
			cities[selectedcityid].center.population -= targetpop
		}
		else{
			var population = cities[selectedcityid].tiles[selectedcitytilex + "_" + selectedcitytiley].population
			if (population - targetpop < mincitytilepop){
				alert("Not enough population!")
				return
			}
			cities[selectedcityid].tiles[selectedcitytilex + "_" + selectedcitytiley].population -= targetpop
		}

		showCitySidebar(selectedcityid, selectedcitytilex, selectedcitytiley)
		addPeople(selectedcitytilex, selectedcitytiley)
	}


	function expandCity(dir, argx='', argy='', argid='', self = true){
		var x = argx
		var y = argy
		var id = argid

		if (isNaN(argx) || isNaN(argy) || isNaN(argid) || argx === '' || argy === '' || argid === ''){
			var x = selectedcitytilex
			var y = selectedcitytiley
			var id = selectedcityid
		}

		var targetx = x + (1*dir[0])
		var targety = y + (1*dir[1])
		var targetpop = 50

		//ensure that tile is valid
		if (!checkValidTile([targetx, targety])){
			return
		}

		//if self, tile must be explored
		if (!exploredtiles.includes(targetx + "," + targety) && self){
			return
		}

		//ensure that the tile is not water
		if (isWater(grid_dict["tile_" + targetx + "_" + targety].type)){
			return
		}

		//ensure that the tile is not too high up
		if (getTileAt(targetx, targety).height > MOUNTAIN_STONE_HEIGHT){
			return
		}

		//check if tile is already in current city
		//(cities[selectedcityid].center.x == targetx && cities[selectedcityid].center.y == targety)
		if (isCityCenter(id, targetx, targety) || cities[id].tiles[targetx + "_" + targety] != undefined){
			return
		}

		//check if tile is in another city
		if (isTileCity(targetx, targety)){
			return
		}

		//ensure that there is enough population for expansion to occur
		//first check for city center
		if (isCityCenter(id, x, y)){
			if (cities[id].center.population - targetpop < mincitytilepop){
				alert("Not enough population to expand!")
				return
			}
			cities[id].center.population -= targetpop
		}
		else{
			//and now check for other tiles
			if (cities[id].tiles[x + "_" + y].population - targetpop < mincitytilepop){
				alert("Not enough population to expand!")
				return
			}
			cities[id].tiles[x + "_" + y].population -= targetpop
		}

		cities[id].tiles[targetx + "_" + targety] = new Object()

		//var loader = new THREE.GLTFLoader();

		//loader.load('/resources/buildings/townhall.glb',
			// called when the resource is loaded
			//function ( gltf ) {


		var texture = THREE.SkeletonUtils.clone(TOWN_HALL_TEXTURE)//TOWN_HALL_TEXTURE.clone()

		//texture.scale.set( 1, 1, 1 );
		//gltf.scene.children[1].children[0].distance = 0.5
		var zoff = getTileAt(targetx, targety).height + base_tile_height
		texture.position.set(targetx, targety, ground_z + zoff)

		texture.rotation.x = Math.PI / 2
		texture.city = true
		texture.cityID = id
		texture.visible = false

		if (activetiles.includes(targetx + "," + targety) || self){
			texture.visible = true
		}

		scene.add( texture );

		assignCity(targetx, targety, id, texture)

		cities[id].tiles[targetx + "_" + targety].x = targetx
		cities[id].tiles[targetx + "_" + targety].y = targety
		cities[id].tiles[targetx + "_" + targety].mesh = texture
		cities[id].tiles[targetx + "_" + targety].population = 50
		cities[id].tiles[targetx + "_" + targety].pop_size = 1

		if (self){
			activateTilesAtCenter(targetx, targety)
			showCitySidebar(id, x, y)
		}

		if (in_city_tile_view){
			showCityTileView(id)
		}

		assignTileFood(targetx, targety)
			//}
		//)

		var tile = getTileAt(targetx, targety)
		var l = tile.children.length
		for (var i = 0; i < l; i++){
			if (tile.children[0].tree == true){
				tile.children.pop(0)
			}
		}

		modifyTileBordersOnExpand(x, y, targetx, targety, self)

		checkAndLoad(targetx, targety, self)

		if (self){
			checkForAdjacentCities(targetx, targety)
		}

		if (self){
			socket.emit('expandcity', dir[0], dir[1], x, y, id)
		}
		//exploreAtCoords(targetx, targety)

		createTileGrid(targetx, targety, false)
	}


	function getTotalPop(cityID){
		var pop = 0

		pop += cities[cityID].center.population

		for (var tile of Object.keys(cities[cityID].tiles)){
			pop += cities[cityID].tiles[tile].population
		}

		return pop
	}

	function changeCityProduction(type){
		if (isNaN(selectedcityid) || selectedcityid === ''){
			return
		}

		if (document.getElementById("select_unit_to_produce_" + type).value == ''){
			cities[selectedcityid].producing[type] = null
		}
		else{
			cities[selectedcityid].producing[type] = document.getElementById("select_unit_to_produce_" + type).value
			//cities[selectedcityid].production_progress[type] = 0
		}

		showCitySidebar(selectedcityid, selectedcitytilex, selectedcitytiley)
	}


	var city_x_offset = 0
	var cities = []
	var citynames = []
	var naming_city = false
	var current_city = ''
	function buildCity(id, name=''){
		if (id == 'null'){
			return
		}
		if (unitlist[id].type != "P"){
			return
		}
		if (unitlist[id].m <= 0){
			return
		}

		var already_named = false
		if (name != ''){
			if (name.length > 20){
				return
			}
			else{
				already_named = true
			}
		}

		var cityx = unitlist[id].x * 1
		var cityy = unitlist[id].y * 1

		if (isTileCity(cityx, cityy)){
			return
		}

		var citypop = unitlist[id].n * 1


		naming_city = true
		if (already_named){
			naming_city = false
		}

		scene.remove(unitlist[id].mesh)

		assignTileUnitStatus(cityx, cityy, false)

		//keep this id temporarily since both pop and unselect will get rid of it
		var temp_id = id

		unSelectUnit(temp_id)

		unitlist[temp_id] = 'removed'

		var this_city = new Object()
		this_city.center = new Object()

		if (isTileAdjacentToWater(cityx, cityy)){
			this_city.coastal = true
		}
		else{
			this_city.coastal = false
		}

		this_city.producing = new Object()
		for (var type of unit_types){
			this_city.producing[type] = null
		}
		this_city.production_progress = new Object()
		for (var type of unit_types){
			this_city.production_progress[type] = 0
		}

		//var loader = new THREE.GLTFLoader();

		//loader.load('/resources/buildings/cityhall.glb',
			// called when the resource is loaded
			//function ( gltf ) {

				//var texture = gltf.scene
		var texture = THREE.SkeletonUtils.clone(CITY_HALL_TEXTURE)//CITY_HALL_TEXTURE.clone()

		//texture.scale.set( 1, 1, 1 );
		//gltf.scene.children[1].children[0].distance = 0.5
		var zoff = getTileAt(cityx, cityy).height + base_tile_height
		texture.position.set(cityx + city_x_offset, cityy, ground_z + zoff)
		texture.cityID = cities.length

		texture.rotation.x = Math.PI / 2
		texture.city = true
		texture.visible = false

		if (activetiles.includes(cityx + "," + cityy)){
			texture.visible = true
		}

		scene.add( texture );

		this_city.center.mesh = texture
		assignCity(cityx, cityy, cities.length, texture)

		if (already_named){
			citynames.push(name)
			this_city.name = name
			this_city.center.mesh.cityname = name
			this_city.cityID = cities.length
			cities.push(this_city)
		}

		assignTileFood(cityx, cityy)

				//activateTilesAtCenter(cityx, cityy)
			//}
		//)

		var tile = getTileAt(cityx, cityy)
		var l = tile.children.length
		for (var i = 0; i < l; i++){
			if (tile.children[0].tree == true){
				tile.children.pop(0)
			}
		}

		this_city.center.x = cityx
		this_city.center.y = cityy
		this_city.center.population = citypop

		this_city.tiles = new Object()

		current_city = this_city

		if (already_named){
			this_city.owner = 'notself'
		}
		if (!already_named){
			this_city.owner = 'self'
			showCityNamePanel(id)
		}

		drawTileBorders(this_city.center.x, this_city.center.y, [1, 2, 3, 4], !already_named)

		createTileGrid(this_city.center.x, this_city.center.y, true)
	}


	unitlist = []

	function drawUnits(i, emit = true){
		//for (var i = 0; i < units.length; i++){
			if (units[i] == ''){
				return
			}
			if (emit){
				socket.emit('unitcreated', units[i])
			}
			var info = units[i].split("~")
			var unittype = info[0]
			var unitinfo = info[1].split(",")
			var thisunit = {}
			thisunit.unitid = i
			thisunit.type = unittype
			for (var keyvalpair of unitinfo){
				var spl = keyvalpair.split(":")
				var key = spl[0]
				var val = spl[1]
				thisunit[key] = val
			}

			if (emit){
				thisunit.owner = 'self'
				activateTilesAtCenter(thisunit.x, thisunit.y)
			}
			else{
				thisunit.owner = 'notself'
			}

			unitlist.push(thisunit)
			assignTileUnitStatus(thisunit.x, thisunit.y, true, i)
			if (activetiles.includes(thisunit.x + "," + thisunit.y)){
				var vis = true
			}
			else{
				var vis = false
			}


			if (unittype == "P"){
				//fetchAndRender([thisunit.x * 1, thisunit.y * 1], [thisunit.x*1 + 1, thisunit.y*1 + 1])
				drawPeople(thisunit.x, thisunit.y, thisunit.unitid, vis)
			}
			if (unittype == "RB"){
				drawRiverboat(thisunit.x, thisunit.y, thisunit.unitid, vis)
			}
			if (unittype == "L"){
				drawLegion(thisunit.x, thisunit.y, thisunit.unitid, vis)
			}
		//}
	}


	//TILE FETCHING AND DRAWING CODE

	function fetchAndRender(coords1, coords2){
		for (var y = coords1[1]; y < coords2[1]; y++){
			for (var x = coords1[0]; x < coords2[0]; x++){
				var req = new XMLHttpRequest;
				req.open("GET", "/gettile?x=" + x + "&y=" + y + "&file=" + FILE)
				req.send()
				req.onreadystatechange = function(){
					if (this.readyState == 4 && this.status == 200){
						var r = this.responseText.replace("[", '').replace("]", '')
						r = r.replace("{", '').replace("}", '').split('","')
						r[0] = r[0].split(":")[1].replaceAll('"', '')
						r[1] = r[1].split(":")[1].replaceAll('"', '')
						var x = r[0].split("_")[0] * 1
						var y = r[0].split("_")[1] * 1
						draw(x, y, r[1])
					}
				}
			}
		}
	}

	//draw the terrain
	//function draw(coords1, coords2, data){
	var WATERGEO = new THREE.PlaneGeometry(1, 1)
	var BASE_TILE_GEO = new THREE.BoxGeometry(1, 1, 0.2)
	function draw(x, y, data){
		if (getTileAt(x, y) != undefined){
			return
		}
		//var tiledata = data[y % 100][x % 100].split("#")[1]
		//var height = data[y % 100][x % 100].split("#")[0] * 1
		var tiledata = data.split(HEIGHT_DELIMITER)[1]
		var height = data.split(HEIGHT_DELIMITER)[0] * 1
		var type = tiledata.split(INFO_DELIMITER)[0]
		var forest = false

		if (type == LAND_TILE_CODE){
			col = getLandCol(x, y)
		}

		if (isWater(type)){
			col = getWaterCol(x ,y)
		}

		if (type == FOREST_TILE_CODE || type == FOREST_START_TILE_CODE){
			forest = true;
			treestodraw = tiledata.split("|")[1] * 1
			col = getForestCol(x, y)
		}

		if (height == 0 && isWater(type)){
			var geometry = WATERGEO//new THREE.PlaneGeometry( 1, 1 );
		}
		else if (height == 0 && !isWater(type)){
			height = height + base_tile_height
			var geometry = new THREE.BoxGeometry(1, 1, height)
		}
		else{
			height = height + base_tile_height
			if (height === 0.2){
				var geometry = BASE_TILE_GEO
			}
			else{
				var geometry = new THREE.BoxGeometry(1, 1, height)
			}
			var heightmod = 1 - height/5
			var mincolormtn = 0.2

			if (height > MOUNTAIN_FOREST_HEIGHT){
				col = getForestCol(x, y)
			}
			for (var it = 0; it < height - 2; it++){
				col.r = col.r + (mincolormtn - col.r) / 2
				col.g = col.g + (mincolormtn - col.g) / 2
				col.b = col.b + (mincolormtn - col.b) / 2
			}
			if (height > MOUNTAIN_STONE_HEIGHT){
				col = getStoneCol(x, y)
			}
			if (height > MOUNTAIN_SNOWCAP_HEIGHT && height <= MOUNTAIN_SNOW_HEIGHT){
				var faces = geometry.faces
				for (var face of faces){
					if (face.normal.z == 1){
						face.color.set(getSnowCol(x, y))
					}
					else{
						face.color.set(col)
					}
				}
				geometry.colorsNeedUpdate = true;//col = getSnowCol()
			}
			if (height > MOUNTAIN_SNOW_HEIGHT){
				col = getSnowCol(x, y)
			}
		}
		geometry = new THREE.BufferGeometry().fromGeometry(geometry)

		var tilematerial = new THREE.MeshBasicMaterial( {color: col, vertexColors: THREE.FaceColors } )//, side: THREE.DoubleSide} );
		var plane = new THREE.Mesh( geometry, tilematerial );
		plane.istile = true
		plane.type = type
		plane.height = height - base_tile_height
		plane.name = "tile_" + x + "_" + y
		grid_dict["tile_" + x + "_" + y] = plane

		plane.position.set(x, y, ground_z + height/2)

		plane.lookAt(x, y, 50)
		scene.add(plane);

		if (forest){
			for (var treegen = 0; treegen < treestodraw; treegen++){
				drawTree([x, y], height, 1)
				drawTree([x, y], height, 2)
				drawTree([x, y], height, 3)
			}
		}

		var treeprob = 324 * WORLD_SEED / (x * y / 23)
		treeprob = (treeprob % 40) / 40

		if (treeprob > 0.9 && type == 'l') {
			drawTree([x, y], height, 1)
			//drawTree([x, y], height)
		}

		if (exploredtiles.includes(x + "," + y)){
		}
		else{
			plane.visible = false
		}
	}


	document.onkeypress = function (e) {
		if (naming_city){
			return
		}
		var code = e.keyCode
		var letter = String.fromCharCode(code)
		if (letter == 'c'){
			center()
			return
		}
		if (letter == 's'){
			if (cameralooking == 'front'){
				camera.lookAt(camera.position.x, camera.position.y - 5, camera.position.z - 5)
				camera.position.y += 10
				camera.rotateOnAxis(new THREE.Vector3(0, 0, 1), Math.PI)
				cameralooking = 'back'
				directionalLight_fromSouth.position.set(camera.position.x, camera.position.y, ground_z + light_z_offset)
				directionalLight_fromSouth.target.position.set(camera.position.x, camera.position.y - 5, ground_z)
			}
		}
		if (letter == 'w'){
			if (cameralooking == 'back'){
				camera.lookAt(camera.position.x, camera.position.y + 5, camera.position.z - 5)
				camera.position.y -= 10
				//camera.rotateOnAxis(new THREE.Vector3(0, 0, 1), Math.PI)
				cameralooking = 'front'
				directionalLight_fromSouth.position.set(camera.position.x, camera.position.y, ground_z + light_z_offset)
				directionalLight_fromSouth.target.position.set(camera.position.x, camera.position.y + 5, ground_z)
			}
		}
		if (letter == 'z'){
			camera.position.z -= 0.2
		}

		if (letter == 'g' && selectedunitid != 'null'){
			moving_unit = true
			updateUnitBar(selectedunitid)
		}

		if (letter == 'b' && selectedunitid != 'null'){
			if (unitlist[selectedunitid].type == "P"){
				buildCity(selectedunitid)
			}
		}

		if (letter == 'v' && selectedcityid != "null"){
			showCityTileView(selectedcityid)
		}
	};

	var velcap = 5
	var leftarrowdown = false
	var rightarrowdown = false
	var uparrowdown = false
	var downarrowdown = false
	document.onkeydown = function(e) {
		if (naming_city){
			return
		}

		var code = e.keyCode

		if (in_tile_level_interface){
			unSelectSubtile()
			return
		}

		var cameramovement = 0.6
		var realign = false;
		if (cameralooking == 'back'){
			cameramovement *= -1
		}

		if (code == esckeycode){
			if (in_tile_level_interface){
				return
			}
			if (redirecting_food){
				redirecting_food = false
				return
			}
			if (selectedunitid != "null"){
				unSelectUnit(selectedunitid)
				return
			}
			if (in_city_tile_view){
				hideCityTileView()
				return
			}
			if (viewing_city_sidebar){
				hideCitySidebar()
				return
			}
		}

		if (code == endturnkeycode){//enterkeycode){
			endTurn()
		}

		if (code == leftarrowcode){
			leftarrowdown = true
			//cameravelocity.x -= cameramovement
			//camera.position.x -= cameramovement
		}
		if (code == rightarrowcode){
			rightarrowdown = true
			//cameravelocity.x += cameramovement
			//camera.position.x += cameramovement
		}
		if (code == uparrowcode){
			uparrowdown = true
			//cameravelocity.y += cameramovement
			//camera.position.y += cameramovement
		}
		if (code == downarrowcode){
			downarrowdown = true
			//cameravelocity.y -= cameramovement
			//camera.position.y -= cameramovement
		}

		if (code == spacekeycode){
			camera.position.z += 0.2
		}

		if (cameravelocity.x > velcap){
			cameravelocity.x = velcap
		}
		if (cameravelocity.y > velcap){
			cameravelocity.y = velcap
		}
		if (cameravelocity.x < -velcap){
			cameravelocity.x = -velcap
		}
		if (cameravelocity.y < -velcap){
			cameravelocity.y = -velcap
		}
		if (realign){
			//controls.target = new THREE.Vector3(camera.position.x, camera.position.y - camerainity, camera.position.z - camerainitz)
		}
	}

	document.onkeyup = function(event){
		var code = event.keyCode
		
		if (code == leftarrowcode){
			leftarrowdown = false
			//camera.position.x -= cameramovement
		}
		if (code == rightarrowcode){
			rightarrowdown = false
			//camera.position.x += cameramovement
		}
		if (code == uparrowcode){
			uparrowdown = false
			//camera.position.y += cameramovement
		}
		if (code == downarrowcode){
			downarrowdown = false
			//camera.position.y -= cameramovement
		}
	}

	function pauseGame(){
		paused = true
		var b = document.getElementById("play_or_pause")
		b.textContent = "Play Game"
		b.style.backgroundColor = "#88b488"
	}

	function playGame(){
		paused = false
		var b = document.getElementById("play_or_pause")
		b.textContent = "Pause Game"
		b.style.backgroundColor = "#b48888"
	}

	function pauseOrPlayGame(){
		if (paused){
			playGame()
			requestAnimationFrame(animate)
		}
		else if (!paused){
			pauseGame()
		}
	}


	window.addEventListener( 'resize', onWindowResize, false );

	var resize_timeout;

	function onWindowResize(){

		clearTimeout(resize_timeout)

		resize_timeout = setTimeout(function(){
		    tile_level_renderer.setSize( window.innerHeight, window.innerHeight );

		    camera.aspect = window.innerWidth / window.innerHeight;
		    camera.updateProjectionMatrix();

		    renderer.setSize( window.innerWidth, window.innerHeight )
		}, 150)
	}

	var decel_amt = 0.05
	var paused = false
	function animate() {
		if (!paused){
			var cameramovement = 0.15

			if (cameralooking == 'back'){
				cameramovement *= -1
			}

			if (leftarrowdown){
				cameravelocity.x -= cameramovement
				//camera.position.x -= cameramovement
			}
			if (rightarrowdown){
				cameravelocity.x += cameramovement
				//camera.position.x += cameramovement
			}
			if (uparrowdown){
				cameravelocity.y += cameramovement
				//camera.position.y += cameramovement
			}
			if (downarrowdown){
				cameravelocity.y -= cameramovement
				//camera.position.y -= cameramovement
			}


			var xcammod = cameravelocity.x * 0.1
			var ycammod = cameravelocity.y * 0.1
			camera.position.x += xcammod
			camera.position.y += ycammod


			//deal with deceleration of camera
			var x_vel_sign = 1
			var y_vel_sign = 1
			if (cameravelocity.x != 0){
				x_vel_sign = cameravelocity.x / Math.abs(cameravelocity.x)
			}
			if (cameravelocity.y != 0){
				y_vel_sign = cameravelocity.y / Math.abs(cameravelocity.y)
			}

			var x_temp_vel = Math.abs(cameravelocity.x) - decel_amt
			var y_temp_vel = Math.abs(cameravelocity.y) - decel_amt

			if (x_temp_vel < 0){
				x_temp_vel = 0
			}

			if (y_temp_vel < 0){
				y_temp_vel = 0
			}

			cameravelocity.x = x_temp_vel * x_vel_sign
			cameravelocity.y = y_temp_vel * y_vel_sign


			//cameravelocity.x += (-cameravelocity.x) * 0.1
			//cameravelocity.y += (-cameravelocity.y) * 0.1

			//controls.update();

			/*directionalLight_fromSouth.position.set(camera.position.x, camera.position.y, ground_z + light_z_offset)
			if (cameralooking == 'front'){
				directionalLight_fromSouth.target.position.set(camera.position.x, camera.position.y + 5, ground_z)
			}
			else{
				directionalLight_fromSouth.target.position.set(camera.position.x, camera.position.y - 5, ground_z)
			}*/
			//scene.add(directionalLight_fromSouth);
			//scene.add(directionalLight_fromSouth.target)

			renderer.render( scene, camera );

			updateCityLabels()
		}

		if (in_tile_level_interface){
			tile_level_renderer.render( tile_level_scene, tile_level_camera)
		}

		requestAnimationFrame( animate );
	}

	var done_init = false
	//init function



	if (!multi){
		var filereq = new XMLHttpRequest;
		filereq.open("GET", "/numsaves")
		filereq.send()
		filereq.onreadystatechange = function(){
			if (this.readyState == 4 && this.status == 200){
				FILE = "map" + String(Math.ceil(Math.random() * (this.responseText * 1)))
				var spawnlocreq = new XMLHttpRequest;
				spawnlocreq.open("GET", "/spawnlocsbyfile/" + FILE)
				spawnlocreq.send()
				spawnlocreq.onreadystatechange = function(){
					if (this.readyState == 4 && this.status == 200){
						var locs = this.responseText.split("\n")
						loc = locs[0]
						loc = loc.split(",")
						let x = loc[0] * 1
						let y = loc[1] * 1
						initialize(x, y, locs)
					}
				}
			}
		}
	}
	//initialize()


	//SOCKET HANDLING AND SUCH
	socket.on('whoareyou', function(){
		socket.emit('i_am', GAMEID)
	})

	socket.on('yourturn', function(playernum){
		if (!done_init){
			var room = window.location.href.split("/").slice(-1)
			var spawnlocreq = new XMLHttpRequest;
			spawnlocreq.open("GET", "/spawnlocs/" + room)
			spawnlocreq.send()
			spawnlocreq.onreadystatechange = function (){
				if (this.readyState == 4 && this.status == 200){
					var locs = this.responseText.split("\n")
					locs.pop()
					//console.log(locs)
					loc = locs[playernum]
					loc = loc.split(",")
					let x = loc[0] * 1
					let y = loc[1] * 1
					initialize(x, y, locs)
					done_init = true
				}
			}
		}
		else{
			hideLoadingScreen()
		}
		//myturn = true
	})


	var ending_game = false
	socket.on('endgame', function(){
		if (ending_game){
			return
		}
		ending_game = true
		setTimeout(function(){
			window.location.replace("/")
		}, 2000)
		alert("A player left the game. Ending game, redircting back home...")
	})

	//SOCKET GAME MECHANICS
	socket.on('unitcreated', function(unit){
		//console.log("here", unit)
		units.push(unit)
		if (done_init){
			drawUnits(units.length - 1, false)
		}
	})

	socket.on('moveunit', function(id, x, y, z){
		if (id > unitlist.length - 1){
			return
		}

		checkAndLoad(x, y, false)

		//if (exploredtiles.includes(unitlist[id].mesh.position.x + "," + unitlist[id].mesh.position.y)){
		assignTileUnitStatus(unitlist[id].mesh.position.x, unitlist[id].mesh.position.y, false)
		//}

		//if (exploredtiles.includes(x + "," + y)){
		assignTileUnitStatus(x, y, true, id)
		//}
		unitlist[id].mesh.position.set(x, y, z)
		unitlist[id].x = x * 1
		unitlist[id].y = y * 1

		if (activetiles.includes(x + "," + y)){
			unitlist[id].mesh.visible = true
		}
		else{
			unitlist[id].mesh.visible = false
		}
	})

	socket.on('buildcity', function(id, name){
		buildCity(id, name)
	})

	socket.on('expandcity', function(dir0, dir1, x, y, id){
		expandCity([dir0, dir1], x, y, id, false)
	})

	socket.on('redirectfood', function(x1, y1, x2, y2, amt){
		console.log(x1, x2, y1, y2, amt)
		reAssignFood([x1*1, y1*1], [x2*1, y2*1], amt*1)
	})

	socket.on('addbuilding', function(subtile, texturename, x, y, id){
		renderBuilding(texturename, subtile, x, y, id, false)
	})

	socket.on('removebuilding', function(subtile, x, y, id){
		removeBuilding(subtile_code, x, y, id)
	})

</script>

</html>
